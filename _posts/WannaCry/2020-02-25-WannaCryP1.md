---
title: "WannaCry P1 - detection & analyse in memeory "
classes: wide
header:
  teaser: /assets/images/WannaCry/p1/logo.gif
ribbon: red
description: "WannaCry was the world monster in 2017 , i will post 2 or 3 parts of my approach on detecting this malware in memory and using the iocs to creat a plugin to auto detect and finding the encryption keys if possible  "
categories:
  - Memory Forensics
  - DFIR 
toc: true
---
Hello all , welcome to first part of wannacry detection , analysis and protection

**WannaCry** is a ransomware that started his attacks in 2017 targeting Microsoft windows machines and caost the world alot  of money .  

after 4 years i decided to do a full analysis to this malware to sharpen my forensics and malware analysis skills  

the malware main attack is encrypting data , but there is another attack i didn't cover in my analysis because it targets the SMB in some windows server so it can spread through the network , to do this attack it used an exploit called **eternalblue** , also the domain that the malware use to download the executable that do this attack did not respond

# Lab Setup 
i used windows7X64bit / 500MB RAM on vmware to run the malware sample , and allwaed it to comunicat over network without using a fakedns or fakenet , then i suspended the vim after 3 minuts of excution .

hero **Volatility** for analysing the memory .

sample hash : 84c82835a5d21bbcf75a61706d8ab549

if you want to try your self you can set up your lab or 
you can skip the setup part and use my memory_dump .
1111111111111111111111111111111111111111111 adddddddddddddddddddddddddddddddddddddddddd thhhhhhhhhhhhhhhhhhhhheee link when the upload finsh .........
dump md5 hash : 8ab0198a80acf83780a47a5f3882eb03

# investgating  
i use vilatilty2 so i have to check the image info to get the profile **i don't have any intentions to move to volatility 3**
its **Win7SP1x64** 

## process check 
i use volatiltiy psxiew so if there were any kind of hiden processes or rootkits , it can be detected 

[![1](/assets/images/WannaCry/p1/i1.png)](/assets/images/WannaCry/p1/i1.png)

nice , no need to pay effort in finding hidden processes or check process threads to find the malware , we can read the processes names and realize the names of the malware processes , we are not sure for now those are all processes but we can sure that those processes are related to the malware . 

the processes are not hidden , but the are some terminated processes , so i will use scan to map processes to there parents .
then ill use dot tool to view it in graphical view 

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64 psscan --output dot --output-file psscan.dot
```
```bash 
dot -Tpng psscan.dot -o psscan.png
```
[![2](/assets/images/WannaCry/p1/i2.png)](/assets/images/WannaCry/p1/i2.png)

the tree is very larg , so we need to zoom in the explorer.exe part as we can find the Wannacry.EXE is child to explorer.exe 

wannacry opened another processes 'taskdl.exe' and 2 '@WanaDecryptor'  one of them opend process 'taskhsvc.exe' 

we can notice process 2752 which is @WanaDecryptor opend 28 second later then the  other one . 

also there is a terminated `taskdl.exe` process in '2021-02-22 17:52:52'

so will we are moving i will check actions for processes 2464 , 2752 , 2092 , ( 2084 is trminated so the expectation is we can't find too much information )
## Privlages 

after we descoverd the malware processes , we can start be checking the privlages for each one 
focus on the enabled only . 

```bash 
vol.py --plugins=my_plugins -f wanncry.vmem --profile Win7SP1x64 privs -p 2464,2752,2092 | grep Enabled
```

[![3](/assets/images/WannaCry/p1/i3.png)](/assets/images/WannaCry/p1/i3.png)

it looks there is no important privlages enabled 

we need to check the privileges of 2084 also , as its a terminated process we need specify the memory offset instad of the process id .  

```bash 
vol.py --plugins=my_plugins -f wanncry.vmem --profile Win7SP1x64 privs --offset=0x000000001e77d2d0
```
but there is no information available , as expected a very large part of its pages may be used to another process or paged in disk . 

to be sure of what happend  to it we can do a pool scan 

## pool object scan 
scaning object types is very usefull becouse it will give us a flag about each data type location , if it was paged in disk or not , so if we didnt find some inforemation about nonpaged objects , that means there is something wrong . 

[![4](/assets/images/WannaCry/p1/i4.png)](/assets/images/WannaCry/p1/i4.png)

process is not a paged object .
so it maen that some pages of process 2084 are used on anther process and overridden 

## handles 

### process 2464 :

