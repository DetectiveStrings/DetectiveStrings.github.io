---
title: "WannaCry P1 - detection & analyse in memeory "
classes: wide
header:  
  teaser: /assets/images/WannaCry/p1/logo.gif
ribbon: red
description: "WannaCry was the world monster in 2017, I will post 2 or 3 parts of my approach on detecting this malware in memory and using the IOCs to create a plugin to auto-detect and finding the encryption keys if possible  "
categories:
  - Memory Forensics
  - DFIR 
toc: true
---
Hello all, welcome to the first part of wannacry detection, analysis and protection

*WannaCry** is ransomware that started its attacks in 2017 targeting Microsoft windows machines and cost the world a lot of money.  

after 4 years I decided to do a full analysis of this malware to sharpen my forensics and malware analysis skills   

the malware main attack is encrypting data, but there is another attack I didn't cover in my analysis because it targets the SMB in some windows server so it can spread through the network, to do this attack it used an exploit called **eternalblue** , also the domain that the malware used to download the executable that does this attack did not respond

# Lab Setup 
I used windows7X64bit / 500MB RAM on VMware to run the malware sample and allowed it to communicate over the network without using a fakedns or fakenet, then I suspended the vim after 3 minutes of execution .

hero **Volatility** for analysing the memory .

sample hash : 84c82835a5d21bbcf75a61706d8ab549

if you want to try your self you can set up your lab or 
you can skip the setup part and use my memory_dump .
1111111111111111111111111111111111111111111 adddddddddddddddddddddddddddddddddddddddddd thhhhhhhhhhhhhhhhhhhhheee link when the upload finsh .........
dump md5 hash : 8ab0198a80acf83780a47a5f3882eb03

# investgating  
I use vilatilty2 so I have to check the image info to get the profile ** I don't have any intentions to move to volatility 3**
its **Win7SP1x64** 

# process check 
I use volatility psxiew so if there were any kind of hidden processes or rootkits, it can be detected 

[![1](/assets/images/WannaCry/p1/i1.png)](/assets/images/WannaCry/p1/i1.png)

nice, no need to pay effort in finding hidden processes or check process threads to find the malware, we can read the processes names and realize the names of the malware processes, we are not sure for now those are all processes but we can sure that those processes are related to the malware. 

the processes are not hidden, but there are some terminated processes, so I will use the psscan to map processes to there parents.
then ill use the dot tool to view it in graphical view 

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64 psscan --output dot --output-file psscan.dot
```
```bash 
dot -Tpng psscan.dot -o psscan.png
```
[![2](/assets/images/WannaCry/p1/i2.png)](/assets/images/WannaCry/p1/i2.png)

the tree is very large, so we need to zoom in the explorer.exe part as we can find the Wannacry.EXE is a child to explorer.exe 

wannacry opened another processes 'taskdl.exe' and 2 '@WanaDecryptor'  one of them opened process 'taskhsvc.exe' 

we can notice process 2752 which is @WanaDecryptor opened 28 seconds later than the other one. 

also, there is a terminated `taskdl.exe` process in '2021-02-22 17:52:52'

so will we are moving I will check actions for processes 2464, 2752, 2092, ( 2084 is terminated so the expectation is we can't find too much information )
# Privileges  

after we discovered the malware processes, we can start by checking the privileges for each one 
focus on the enabled only. 

```bash 
vol.py --plugins=my_plugins -f wanncry.vmem --profile Win7SP1x64 privs -p 2464,2752,2092 | grep Enabled
```

[![3](/assets/images/WannaCry/p1/i3.png)](/assets/images/WannaCry/p1/i3.png)

it looks there are no important privileges enabled 

we need to check the privileges of 2084 also, as its a terminated process we need to specify the memory offset instead of the process id.  

```bash 
vol.py --plugins=my_plugins -f wanncry.vmem --profile Win7SP1x64 privs --offset=0x000000001e77d2d0
```
but there is no information available, as expected a very large part of its pages may be used for another process or paged in the disk. 

to be sure of what happened  to it we can do a pool scan 

# pool object scan 
scanning object types is very useful because it will give us a flag about each data type location, if it was paged in disk or not, so if we didn't find some information about nonpaged objects, that means there is something wrong. 

[![4](/assets/images/WannaCry/p1/i4.png)](/assets/images/WannaCry/p1/i4.png)

the process is not a paged object.
so it means that some pages of process 2084 are used on anther process and overridden 

# handles 

we didn't find useful information in processes privileges, so we will check echo process handles.
the important handles are files, keys, mutex then we will check the vads if we found any kind of process injection we can back to handles and follow the threads.

## Process 2464   
### Files :

```bash
vol.py --plugins=my_plugins -f wanncry.vmem --profile Win7SP1x64 handles -p 2464 -t file
```

[![5](/assets/images/WannaCry/p1/i5.png)](/assets/images/WannaCry/p1/i5.png)

as you can see this process opens several file handles, and there are 2 interesting files 
**00000000.eky** which is located on the desktop, in the same path as with the executable. 
**hibsys.WNCRYT** this file is located in temp and looks interesting, it doesn't look like the encrypted files (the encrypted once ends with )


we can dump those files and check the content for any information 

### Key : 

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64 handles -p 2464 -t key
```

[![6](/assets/images/WannaCry/p1/i6.png)](/assets/images/WannaCry/p1/i6.png)

I don't know the function for each key so I can't decide which key shouldn't be used or why it use each key. 

so the best thing to do is to search all the process to find which process use every single key if we found the key used is not used by any other processor used by all the malware process only or mutual between the malware and important system process, then we can search for the key function and decide is this bad activity or not.  

note: as we saw in the object pool scan keys are paged pool objects so we can't find all the keys resident in memory, some time I will back to the life system to analyse key values, or to understand the key purpose 

every key described with safe mans the exe use them to get system information.

- IMAGE FILE EXECUTION OPTIONS

&emsp;  is safe

- VERSIONS

&emsp; is safe
 
- SESSION MANAGER

&emsp; is safe 

- MACHINE

&emsp;is safe 

- CUSTOMLOCALE 

&emsp;it seems to a safe key, as NLS contains some default keys for the system but it can be a remarkable key for the malware processes, as those processes are the only processes that use this key 

&emsp; ```bash 
&emsp; &emsp; vol.py -f wanncry.vmem --profile Win7SP1x64  handles -t key | grep  'CONTROLSET001\\CONTROL\\NLS\\CUSTOMLOCALE'
&emsp; &emsp; ```

[![8](/assets/images/WannaCry/p1/i8.png)](/assets/images/WannaCry/p1/i8.png)

&emsp; &emsp; but we can't get the key values as this hive is resident in memory 

so I went back to the machine and look at the key-value but the key doesn't have any values 

[![7](/assets/images/WannaCry/p1/i7.png)](/assets/images/WannaCry/p1/i7.png)

- PROPERTYBAG

there are 3 key but located in different hives 

those keys contain some information about the directories on the system.  

as expected those keys hives are not resident in memory. 

and the malware use keys that map to folders "Common Documents", "Personal", "Desctop" and 2 keys point to another key map to "DocumintsLiberary".

[![9](/assets/images/WannaCry/p1/i9.png)](/assets/images/WannaCry/p1/i9.png)

[![10](/assets/images/WannaCry/p1/i10.png)](/assets/images/WannaCry/p1/i10.png)

[![11](/assets/images/WannaCry/p1/i11.png)](/assets/images/WannaCry/p1/i11.png)

- APPCOMPATFLAGS

nothing interesting on this key also it's used by many other processes. 


### Mutannt / Mutex : 

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64  handles  -p 2464 -t mutant 
```

[![12](/assets/images/WannaCry/p1/i12.png)](/assets/images/WannaCry/p1/i12.png)

mutex is very important evidence in wannacry case

we cant view all mutexes because its a disk paged objects like keys  

but we have the important part her 

As you can see, this process uses 2 unique mutexes which are not known on windows.

> Note: in 2017 the DFIR teams used those mutexes to stop wannacry form encrypting data, running PowerShell script to create mutexes with the same name, then they implemented it in some of the very first tools to stop wannacry. 

## Process 2752   

like what we did in process 2752 we will check each process 

### File

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64  handles  -p 2752 -t file 
```

[![13](/assets/images/WannaCry/p1/i13.png)](/assets/images/WannaCry/p1/i13.png)

the interesting files objects are : 

- odbcint.dll.mui  

which is related to odbcint.dll , and it can be used to provide database reading/writing APIs

- MFC42.dll.mui

this dll is related to Microsoft visualStudio, so that means at least this part is written using Microsoft Visual C++ , it can be obfuscated or packed.   

aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaddddddd mmmmmemmmeeee

- StaticCache.dat 

it uses this file to load a font so this may be the process that displays the message

[![14](/assets/images/WannaCry/p1/i14.png)](/assets/images/WannaCry/p1/i14.png)

### Key

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64  handles -p 2752 -t key
```

[![15](/assets/images/WannaCry/p1/i15.png)](/assets/images/WannaCry/p1/i15.png)

there are many keys like its parent "Wannacry.exe".

it has many NLS keys, this may because it needs some information about the local machine time,...., etc. 
remember this is the process that counts the time of payment. 

the new keys are 

- PROTOCOL_CATALOG9,  NAMESPACE_CATALOG5 

those keys are related to windows sockets and network connection, but this process doesn't look like it started a network connection, as there are no handles to any network file to setup the sockets. 

### Mutant / Mutex 

this process has only one mutex but it looks like it's paged to disk 

## Process 2340 

this process is the same executable as the 2752 process but it looks like it has some differences in behaviour , so i will cover only the differences  

### Files : 


[![16](/assets/images/WannaCry/p1/i16.png)](/assets/images/WannaCry/p1/i16.png)

as you can see there are 2 new files handles. 

- Endpoint , AsyncConnectHlp : 

those 2 handles are very important to establish a network connection. 

so we can assume this process is doing a network connection, we will be sure when we come to the network part. 

> also this process can be the one that shows the encryption message, but when you do a live dynamic analysis of the malware you can see the message box appear after 30~60 second from starting the dropper, but for this process, it starts after 5~10 second, so it can't be the message box process, we can also check the windows output for the 2 processes and the process that set to the default output strings is not the encryption message process. 


```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64  windows -p 2340  | grep Name:
```

[![17](/assets/images/WannaCry/p1/i17.png)](/assets/images/WannaCry/p1/i17.png)

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64  windows -p 2752  | grep Name:
```

[![18](/assets/images/WannaCry/p1/i18.png)](/assets/images/WannaCry/p1/i18.png)

the time is set in this process so this is the message box process.

### Key 

all the keys are the same as the 2752 process 

### Mutant / Mutex 

also this process has only one mutex but it looks like it's paged to disk  .

## Process 2092

### File

[![19](/assets/images/WannaCry/p1/i19.png)](/assets/images/WannaCry/p1/i19.png)

- Endpoint , AsyncConnectHlp

this process has a network and sockets files handles more than the previous process. 

- R000000000006.clb 
looks to be an interesting handle but unfortunately, this is a system file used by many processes, so for now we cant say it dropped or a harmful file. 

- Roaming\tor\lock

this is the real inserting handle, as the process uses some file from tor . 
but wait, the machine didn't have tor installed. 
it may be a dropped file, or just this is a file folder called tor located in the Appdata folder. 

we will try to extract this file and check this folder but in other section. 

### Key 

[![20](/assets/images/WannaCry/p1/i20.png)](/assets/images/WannaCry/p1/i20.png) 

there are no interesting or new keys. 

just the same as process 2464, also it has the network key. 

also this process has 3 mutexes but it looks like it's paged to disk  .

# Network

from the previous part, we know that the malware has 2 processes that connect throw the network 2340, 2092.

## 2340 connections 

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64  netscan | grep  2340
```


[![21](/assets/images/WannaCry/p1/i21.png)](/assets/images/WannaCry/p1/i21.png)

this process establishes a connection to the localhost on port 9050, it looks like searching for something related to the exploitation or just checking something. 

## 2092 connections

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64  netscan | grep  2092
```

[![22](/assets/images/WannaCry/p1/i22.png)](/assets/images/WannaCry/p1/i22.png)

nice, as you can see, this process is listening to port 9050, so the private connection was to this process. 

also, it do some connections to the localhost in different ports. 

then it starts to send requests to 5 is (each time those ips are different or at least 3, 4 of them ), the only evidence we have to clarify those connections this behaviour is the tor path on AppData folder, if It was the internet application then it means those connections happened to an onion domain so the route is different almost every time. 

### the connected ips : 
- 94.130.200.167:443
- 51.81.93.162:443
- 83.212.99.68:443
- 204.11.50.131:9001
- 82.149.227.236:9001
- 131.188.40.189:443

> Note: anyway the domains of wannacry aren't working now. 

# dlls scan 

we need to list all it may help to discover which API does the malware use or any strange dll used. 

## 2464 **WannaCry.EXE**

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64   dlllist  -p 2464
```

[![23](/assets/images/WannaCry/p1/i23.png)](/assets/images/WannaCry/p1/i23.png)

no thong is interesting in those Dlls, it uses only the system DLLs.
also, it contains the exe on the virtual base address 0x400000, with a size of 0x3d000, which means the exe is divided into 61 pages, we hope to find it all in the memory vads. 


## 2340 **WannaCry.EXE**

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64   dlllist  -p 2340
```

[![24](/assets/images/WannaCry/p1/i24.png)](/assets/images/WannaCry/p1/i24.png)

nothing is interesting for now in this processes dlls 


## 2752 **WannaCry.EXE**

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64   dlllist  -p 2752
```

[![25](/assets/images/WannaCry/p1/i25.png)](/assets/images/WannaCry/p1/i25.png)

nothing is interesting for now in this processes dlls, it is the same as the other 2340 except it has a cmd argument **co** 

## 2092 **WannaCry.EXE**

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64   dlllist  -p 2092
```

[![26](/assets/images/WannaCry/p1/i26.png)](/assets/images/WannaCry/p1/i26.png)

this is an interesting process dlls, it's not using only the system DLLs, but also it used some other dlls located on the desktop on the same path where the dropper is, in a folder called TaskData. it looks like this folder is one of the dropped data. 

### Markable dlls used : 

- zlib1.dll : it needs this dll in doing compression or decompression (or some kind of unpacking resources ).

- SSLEAY32.dll : it needs this dll for communication as it was sending requests to ips on port 443.

the other dlls it is used in encryption, we will look to it in the analysis part because it will take too much to identify each dll used methods and its functions 

we can count all those dlls on the Taskdata path part of the IOCS. 

we can list all the files on this path and count it with the IOCs, all this file is dropped from the malware...


```bash
vol.py -f wanncry.vmem --profile Win7SP1x64  filescan | grep -i "Desktop\\TaskData"
```

unforsnitly those files objects are not resident in memory 

let's look at the AppData Roaming path if we can find any valid information there. 

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64  filescan | grep  "AppData\\Roaming"
```

[![27](/assets/images/WannaCry/p1/i27.png)](/assets/images/WannaCry/p1/i27.png)

but unfortunately, there is no important data except the path we got before. 

let's try to back one folder and search in all AppData folder, may the malware dropped anything there also. 

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64  filescan | grep  "AppData"
```
[![28](/assets/images/WannaCry/p1/i28.png)](/assets/images/WannaCry/p1/i28.png)

nice, in the local/temp folder there are many folders with extinction WNCRYTows and contains file .db 

[![29](/assets/images/WannaCry/p1/i29.png)](/assets/images/WannaCry/p1/i29.png)

great, there are a lot of databases related to wannacry, the prefix of folders can be an IOCs, also the file hibsys.WNCRYT

