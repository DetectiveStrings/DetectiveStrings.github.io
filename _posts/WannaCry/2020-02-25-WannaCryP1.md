---
title: "WannaCry P1 - detection & analyse in memeory "
classes: wide
header:  
  teaser: /assets/images/WannaCry/p1/logo.gif
ribbon: red
description: "WannaCry was the world monster in 2017, I will post 2 or 3 parts of my approach on detecting this malware in memory and using the IOCs to create a plugin to auto-detect and finding the encryption keys if possible  "
categories:
  - Memory Forensics
  - DFIR 
toc: true
---
Hello all, welcome to the first part of wannacry detection, analysis and protection

*WannaCry** is ransomware that started its attacks in 2017 targeting Microsoft windows machines and cost the world a lot of money.  

after 4 years I decided to do a full analysis of this malware to sharpen my forensics and malware analysis skills   

the malware main attack is encrypting data, but there is another attack I didn't cover in my analysis because it targets the SMB in some windows server so it can spread through the network, to do this attack it used an exploit called **eternalblue** , also the domain that the malware used to download the executable that does this attack did not respond

# Lab Setup 
I used windows7X64bit / 500MB RAM on VMware to run the malware sample and allowed it to communicate over the network without using a fakedns or fakenet, then I suspended the vim after 3 minutes of execution .

hero **Volatility** for analysing the memory .

sample hash : 84c82835a5d21bbcf75a61706d8ab549

if you want to try your self you can set up your lab or 
you can skip the setup part and use my memory_dump .
1111111111111111111111111111111111111111111 adddddddddddddddddddddddddddddddddddddddddd thhhhhhhhhhhhhhhhhhhhheee link when the upload finsh .........
dump md5 hash : 8ab0198a80acf83780a47a5f3882eb03

# investgating  
I use vilatilty2 so I have to check the image info to get the profile ** I don't have any intentions to move to volatility 3**
its **Win7SP1x64** 

# process check 
I use volatility psxiew so if there were any kind of hidden processes or rootkits, it can be detected 

[![1](/assets/images/WannaCry/p1/i1.png)](/assets/images/WannaCry/p1/i1.png)

nice, no need to pay effort in finding hidden processes or check process threads to find the malware, we can read the processes names and realize the names of the malware processes, we are not sure for now those are all processes but we can sure that those processes are related to the malware. 

the processes are not hidden, but there are some terminated processes, so I will use the psscan to map processes to there parents.
then ill use the dot tool to view it in graphical view 

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64 psscan --output dot --output-file psscan.dot
```
```bash 
dot -Tpng psscan.dot -o psscan.png
```
[![2](/assets/images/WannaCry/p1/i2.png)](/assets/images/WannaCry/p1/i2.png)

the tree is very large, so we need to zoom in the explorer.exe part as we can find the Wannacry.EXE is a child to explorer.exe 

wannacry opened another processes 'taskdl.exe' and 2 '@WanaDecryptor'  one of them opened process 'taskhsvc.exe' 

we can notice process 2752 which is @WanaDecryptor opened 28 seconds later than the other one. 

also, there is a terminated `taskdl.exe` process in '2021-02-22 17:52:52'

so will we are moving I will check actions for processes 2464, 2752, 2092, ( 2084 is terminated so the expectation is we can't find too much information )
# Privlages 

after we discovered the malware processes, we can start by checking the privileges for each one 
focus on the enabled only. 

```bash 
vol.py --plugins=my_plugins -f wanncry.vmem --profile Win7SP1x64 privs -p 2464,2752,2092 | grep Enabled
```

[![3](/assets/images/WannaCry/p1/i3.png)](/assets/images/WannaCry/p1/i3.png)

it looks there are no important privileges enabled 

we need to check the privileges of 2084 also, as its a terminated process we need to specify the memory offset instead of the process id.  

```bash 
vol.py --plugins=my_plugins -f wanncry.vmem --profile Win7SP1x64 privs --offset=0x000000001e77d2d0
```
but there is no information available, as expected a very large part of its pages may be used for another process or paged in the disk. 

to be sure of what happened  to it we can do a pool scan 

# pool object scan 
scanning object types is very useful because it will give us a flag about each data type location, if it was paged in disk or not, so if we didn't find some information about nonpaged objects, that means there is something wrong. 

[![4](/assets/images/WannaCry/p1/i4.png)](/assets/images/WannaCry/p1/i4.png)

the process is not a paged object.
so it means that some pages of process 2084 are used on anther process and overridden 

# handles 

we didn't find useful information in processes privileges, so we will check echo process handles.
the important handles are files, keys, mutex then we will check the vads if we found any kind of process injection we can back to handles and follow the threads.

## Process 2464 handles  
### Files :

```bash
vol.py --plugins=my_plugins -f wanncry.vmem --profile Win7SP1x64 handles -p 2464 -t file
```

[![5](/assets/images/WannaCry/p1/i5.png)](/assets/images/WannaCry/p1/i5.png)

as you can see this process opens several file handles, and there are 2 interesting files 
**00000000.eky** which is located on the desktop, in the same path as with the executable. 
**hibsys.WNCRYT** this file is located in temp and looks interesting, it doesn't look like the encrypted files (the encrypted once ends with )


we can dump those files and check the content for any information 

### Key : 

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64 handles -p 2464 -t key
```

[![6](/assets/images/WannaCry/p1/i6.png)](/assets/images/WannaCry/p1/i6.png)

I don't know the function for each key so I can't decide which key shouldn't be used or why it use each key. 

so the best thing to do is to search all the process to find which process use every single key if we found the key used is not used by any other processor used by all the malware process only or mutual between the malware and important system process, then we can search for the key function and decide is this bad activity or not.  

note: as we saw in the object pool scan keys are paged pool objects so we can't find all the keys resident in memory, some time I will back to the life system to analyse key values, or to understand the key purpose 

every key described with safe mans the exe use them to get system information.

- IMAGE FILE EXECUTION OPTIONS

is safe

- VERSIONS

is safe
 
- SESSION MANAGER

is safe 

- MACHINE

is safe 

- CUSTOMLOCALE 

it seems to a safe key, as NLS contains some default keys for the system but it can be a remarkable key for the malware processes, as those processes are the only processes that use this key 

```bash 
vol.py -f wanncry.vmem --profile Win7SP1x64  handles -t key | grep  'CONTROLSET001\\CONTROL\\NLS\\CUSTOMLOCALE'
```

[![8](/assets/images/WannaCry/p1/i8.png)](/assets/images/WannaCry/p1/i8.png)

but we can't get the key values as this hive is resident in memory 

so I went back to the machine and look at the key-value but the key doesn't have any values 

[![7](/assets/images/WannaCry/p1/i7.png)](/assets/images/WannaCry/p1/i7.png)

- PROPERTYBAG

there are 3 key but located in different hives 

those keys contain some information about the directories on the system.  

as expected those keys hives are not resident in memory. 

and the malware use keys that map to folders "Common Documents", "Personal", "Desctop" and 2 keys point to another key map to "DocumintsLiberary".

[![9](/assets/images/WannaCry/p1/i9.png)](/assets/images/WannaCry/p1/i9.png)

[![10](/assets/images/WannaCry/p1/i10.png)](/assets/images/WannaCry/p1/i10.png)

[![11](/assets/images/WannaCry/p1/i11.png)](/assets/images/WannaCry/p1/i11.png)

- APPCOMPATFLAGS

nothing interesting on this key also it's used by many other processes. 


### Mutannt / Mutex : 
